public class PortalForgotPasswordController {
    
    @RemoteAction
    public static String ForgotPassapplication(String emailId){
        try{
            // Validate email input
            if(String.isBlank(emailId)){
                return 'error: Email address is required';
            }
            
            List<Contact> conList = [SELECT Name, Salutation, LastName, Email, Password__c, 
                                    Campaign__c, Login_Hash_Code__c 
                                    FROM Contact 
                                    WHERE Email =: emailId 
                                    LIMIT 1];
            
            if(conList.isEmpty()){
                return 'error: Email not found';
            }
            
            Contact con = conList[0];
            
            // Generate new hash code for password reset
            con.Login_Hash_Code__c = Utility.generateRandomString();
            update con;
            
            System.debug('Generated Login Hash Code: ' + con.Login_Hash_Code__c);
            System.debug('Contact Email: ' + con.Email);
            
            // Use single email template name
            String emailTempName = 'Email to Contact for Reset Password';
            
            List<EmailTemplate> tempList = [SELECT Id, Name, HTMLValue, Subject, Body 
                                           FROM EmailTemplate 
                                           WHERE Name =: emailTempName 
                                           LIMIT 1];
            
            if(tempList.isEmpty()){
                System.debug('Email template not found: ' + emailTempName);
                return 'error: Email template configuration error';
            }
            
            EmailTemplate temp = tempList[0];
            
            // Get Org-Wide Email Address
            String orgWideEmailName = Label.OrgWideEmailAddress;
            List<OrgWideEmailAddress> oweaList = [SELECT Id, Address, DisplayName 
                                                  FROM OrgWideEmailAddress 
                                                  WHERE DisplayName = :orgWideEmailName 
                                                  LIMIT 1];
            
            // Prepare email body with proper merge field replacement
            String htmlBody = temp.HTMLValue;
            String subject = temp.Subject;
            String plainTextBody = temp.Body;
            
            // Build contact name properly
            String contactName = con.Name;
            if(String.isNotBlank(con.Salutation) && String.isNotBlank(con.LastName)){
                contactName = con.Salutation + ' ' + con.LastName;
            } else if(String.isNotBlank(con.LastName)){
                contactName = con.LastName;
            }
            
            // Get Site Base URL from Custom Label
            String siteBaseURL = Label.Site_Base_URL;
            
            // Build reset link URL
            String resetLink = siteBaseURL + '/ApplicantDashboard/ApplicationForgotPassword?id=' + con.Login_Hash_Code__c;
            
            System.debug('Reset Link: ' + resetLink);
            
            // Replace merge fields in HTML body
            htmlBody = htmlBody.replace('{!Contact.Name}', contactName);
            htmlBody = htmlBody.replace('{!Contact.Login_Hash_Code__c}', con.Login_Hash_Code__c);
            htmlBody = htmlBody.replace('{!$Label.Site_Base_URL}', siteBaseURL);
            
            // Replace merge fields in plain text body
            if(String.isNotBlank(plainTextBody)){
                plainTextBody = plainTextBody.replace('{!Contact.Name}', contactName);
                plainTextBody = plainTextBody.replace('{!Contact.Login_Hash_Code__c}', con.Login_Hash_Code__c);
                plainTextBody = plainTextBody.replace('{!$Label.Site_Base_URL}', siteBaseURL);
            }
            
            // Create and send email
            Messaging.SingleEmailMessage mail = new Messaging.SingleEmailMessage();
            
            if (!oweaList.isEmpty()) {
                mail.setOrgWideEmailAddressId(oweaList[0].Id);
                System.debug('Using Org-Wide Email: ' + oweaList[0].Address);
            } else {
                System.debug('No Org-Wide Email Address found, using default');
            }
            
            mail.setHtmlBody(htmlBody);
            mail.setSubject(subject);
            
            if(String.isNotBlank(plainTextBody)){
                mail.setPlainTextBody(plainTextBody);
            }
            
            mail.setToAddresses(new String[] { con.Email });
            mail.setSaveAsActivity(false);
            
            // Send email
            List<Messaging.SendEmailResult> results = Messaging.sendEmail(new List<Messaging.SingleEmailMessage>{ mail });
            
            // Check if email was sent successfully
            if(results[0].isSuccess()){
                System.debug('Email sent successfully to: ' + con.Email);
                return 'success';
            } else {
                System.debug('Email send failed: ' + results[0].getErrors()[0].getMessage());
                return 'error: Failed to send email';
            }
            
        } catch(Exception e){
            System.debug('Error in ForgotPassapplication: ' + e.getMessage());
            System.debug('Error Line: ' + e.getLineNumber());
            System.debug('Stack Trace: ' + e.getStackTraceString());
            return 'error: ' + e.getMessage();
        }
    }
    
    // Password Reset Application Portal
    @RemoteAction
    public static String ApplicationPasswordReset(String password, String loginhashcode){
        try{
            if(String.isBlank(password) || String.isBlank(loginhashcode)){
                return 'error: Missing required parameters';
            }
            
            System.debug('Attempting password reset for hash: ' + loginhashcode);
            
            List<Contact> conList = [SELECT Name, Email, Password__c, Campaign__c, Login_Hash_Code__c 
                                    FROM Contact 
                                    WHERE Login_Hash_Code__c =: loginhashcode 
                                    LIMIT 1];
            
            if(conList.isEmpty()){
                System.debug('No contact found with hash code: ' + loginhashcode);
                return 'error: Invalid or expired reset link';
            }
            
            Contact conToUpdate = conList[0];
            conToUpdate.Password__c = password;
            
            // Regenerate hash code after password reset for security
            conToUpdate.Login_Hash_Code__c = Utility.generateRandomString();
            
            update conToUpdate;
            
            System.debug('Password reset successful for: ' + conToUpdate.Email);
            
            return 'success';
            
        } catch(Exception e){
            System.debug('Error in ApplicationPasswordReset: ' + e.getMessage());
            System.debug('Error Line: ' + e.getLineNumber());
            return 'error: ' + e.getMessage();
        }
    }
    
    @RemoteAction
    public static String getCampaign(String loginhashcode){
        try{
            if(String.isBlank(loginhashcode)){
                return '';
            }
            
            List<Contact> conList = [SELECT Campaign__c 
                                    FROM Contact 
                                    WHERE Login_Hash_Code__c =: loginhashcode 
                                    LIMIT 1];
            
            if(conList.isEmpty()){
                return '';
            }
            
            return conList[0].Campaign__c != null ? conList[0].Campaign__c : '';
            
        } catch(Exception e){
            System.debug('Error in getCampaign: ' + e.getMessage());
            System.debug('Error Line: ' + e.getLineNumber());
            return '';
        }
    }
    
    @RemoteAction
    public static Contact getPasswordHint(String emailId){
        Contact conRec = new Contact();
        try{
            List<Contact> conList = [SELECT Id, Password_Hint__c 
                                    FROM Contact 
                                    WHERE Email =: emailId 
                                    LIMIT 1];
            
            if(!conList.isEmpty()){
                conRec = conList[0];
            }
            
            return conRec;
            
        } catch(Exception e){
            System.debug('Error in getPasswordHint: ' + e.getMessage());
            return conRec;
        }
    }
    
    @RemoteAction
    public static WrapperLinksCampaign getFAQLinks(String programme){
        WrapperLinksCampaign wrapper = new WrapperLinksCampaign();
        FAQ_Links__c links = new FAQ_Links__c();
        
        try{
            List<Campaign> campaignList = [SELECT Id, Name, Description, Actual_End_Date__c, 
                                          Disable_Campaign__c, EndDate, Image_URL__c, 
                                          RedirectPage__c, Cut_Off_Start_Date__c, Cut_Off_End_Date__c 
                                          FROM Campaign];                                
            wrapper.listCampaign = campaignList;
            
            List<FAQ_Links__c> linksList = [SELECT Id, Name, Basic_Guidelines__c, Call_Text__c, 
                                           FAQs__c, Programme__c 
                                           FROM FAQ_Links__c 
                                           WHERE Programme__c =: programme 
                                           LIMIT 1];
            
            if(!linksList.isEmpty()){
                wrapper.link = linksList[0];
            } else {
                wrapper.link = links;
            }
            
            return wrapper;
            
        } catch(Exception e){
            System.debug('Error in getFAQLinks: ' + e.getMessage());
            System.debug('Error Line: ' + e.getLineNumber());
            wrapper.link = links;
            return wrapper;
        }
    }
    
    // Wrapper class for FAQ Links
    public class WrapperLinksCampaign {
        public List<Campaign> listCampaign { get; set; }
        public FAQ_Links__c link { get; set; }
        
        public WrapperLinksCampaign(){
            listCampaign = new List<Campaign>();
            link = new FAQ_Links__c();
        }
    }
}