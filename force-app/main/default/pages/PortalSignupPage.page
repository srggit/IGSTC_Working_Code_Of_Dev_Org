<apex:page showHeader="false" sidebar="false" docType="html-5.0" controller="RegistrationController" extensions="CaptchaController">
    <apex:includescript value="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"/>
    <apex:stylesheet value="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #FFFFFF; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; box-sizing: border-box; }
        .header-section { text-align: center; padding: 20px 0; width: 100%; height: 10vh; }
        .logo { width: 120px; height: auto; }
        .welcome-text { font-size: 22px; font-weight: 700; color: #4b0082; }
        .main-container {padding: 15px 0; display: flex; flex-direction: column; width: 75%; margin: 0 auto; height: 78vh; justify-content: space-evenly; box-shadow: 0px 2px 20px 2px #0000000D, 1px 0px 20px 2px #FFFFFF0D; border-radius: 24px; }
        .field-container{ display: flex; width:100%; height:57%; justify-content: space-between; padding-bottom: 0;}
        .login-section { padding:10px 30px 10px 30px; width: 50%; display: flex; flex-direction: column; justify-content: space-between; }
        .right-section{ padding: 10px 30px 10px 30px; width: 50%; display: flex; flex-direction: column; justify-content: space-between; } 
        .login-logo { display: block; margin: 0 auto 10px auto; width: 40px; height: 40px; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0px 4px 40px 6px #4D33A31A; display: flex; flex-direction: column; justify-content: space-evenly; }
        .login-title { font-size: 20px; font-weight: 700; color: #4b0082; margin-bottom: 7px; text-align: center; letter-spacing: 1%; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .last-group{ margin-bottom: 5px; }
        .form-label { display: block; color: #4b0082; margin-bottom: 5px; font-size: 99%; font-weight: 500; }
        .form-label .required { color: red; }
        .label-icon { margin-right: 5px; margin-left: 5px; color: #4b0082; width: 16px; }
        .form-input { width: 100%; padding: 6px 10px; border: 1px solid #7A7A7A80; border-radius: 6px; font-size: 14px; height: 35px; box-sizing: border-box; }
        .captcha-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .captcha-code { font-size: 18px; font-weight: bold; color: #333; background: #f5f5f5; padding: 8px 12px; border-radius: 4px; letter-spacing: 2px;  }
        .login-btn { width: 45%; height:11.5%; backgrRegistrationControlleround: #4b0082; color: white; border: none; border-radius: 8px; font-size: 125%; font-weight: 700; cursor: pointer; margin: auto; margin-bottom: 10px; display:flex; align-items: center; justify-content: center;}
        .login-btn:hover { background: #3a0069; }
        .signup-link { text-align: center; color: #7A7A7A; font-size: 97%; font-weight: 500; letter-spacing: 1%; }
        .signup-link a { color: #4b0082; text-decoration: none; font-weight: bold; } 
        /* message boxes */
        .alert { width: 90%; margin: 8px auto 0; padding: 10px 12px; border-radius: 6px; font-size: 14px; display:none; }
        .alert.success { background: #e6ffed; color: #065f46; border:1px solid #a7f3d0; }
        .alert.error   { background: #fef2f2; color: #991b1b; border:1px solid #fecaca; }
        
        @media (min-width: 1400px) { .header-section{ padding: 20px 0; } .main-container{padding: 30px 0; height: 80%; width: 70%; } .login-logo{ padding: 20px; margin: 0 auto 20px auto; } .login-title{ font-size: 20px; margin-bottom: 30px; } .form-group{ margin-bottom: 50px; } .form-label{
            font-size: 18px;
        } .form-input{
            height: 48px;
        } .signup-link{
            font-size: 18px;
        } .login-btn{ height: 48px; font-size: 22px; } }
        @media (max-width: 768px) { .main-container { flex-direction: column; width: 95%; gap: 20px; } }
    </style>
    
    <script>
    // Helpers
    function val(id){ var el = document.getElementById(id); return el ? el.value.trim() : ''; }
    function isEmail(s){ return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(s); }
    function norm(s){ return (s || '').replace(/\s+/g,'').toLowerCase(); }
    function showMsg(type, msg){
        var ok = document.getElementById('msg-success');
        var er = document.getElementById('msg-error');
        if (ok) ok.style.display = 'none';
        if (er) er.style.display = 'none';
        if(type === 'success' && ok){ ok.textContent = msg; ok.style.display = 'block'; }
        else if (er) { er.textContent = msg; er.style.display = 'block'; }
    }
    function setLoading(isLoading){
        var btn = document.getElementById('btn-register');
        var spn = document.getElementById('spinner');
        if (btn) btn.disabled = !!isLoading;
        if (spn) spn.style.display = isLoading ? 'inline-block' : 'none';
    }
    
    // Clearer call path: inline onclick uses this
    function registerNow(){
        // debugger; // uncomment if you want to pause on click
        showMsg('error',''); // clear previous
        
        var firstName = val('reg-firstname');
        var lastName  = val('reg-lastname');
        var email     = val('reg-email');
        var pass      = val('reg-pass');
        var confirm   = val('reg-confirm');
        var captchaIn = val('reg-captcha');
        var captchaEl = document.getElementById('captcha-code');
        var captchaShown = captchaEl ? norm(captchaEl.textContent) : '';
        
        if(!firstName || !lastName || !email || !pass || !confirm){
            showMsg('error','Please fill all required fields.');
            return;
        }
        if(!isEmail(email)){
            showMsg('error','Please enter a valid email address.');
            return;
        }
        if(pass !== confirm){
            showMsg('error','Passwords do not match.');
            return;
        }
        if(captchaEl && norm(captchaIn) !== captchaShown){
            showMsg('error','Invalid captcha.');
            return;
        }
        
        setLoading(true);
        
        // Call the Apex @RemoteAction
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.RegistrationController.register}',
            firstName, lastName, email, pass,
            function(result, event){
                setLoading(false);
                if(event.status){
                    if(result && result.success){
                        showMsg('success', result.message || 'Registration successful.');
                        // Optional: redirect to login
                        // window.location.href = '/apex/YourLoginPage';
                    }else{
                        showMsg('error', (result && result.message) ? result.message : 'Registration failed.');
                    }
                }else{
                    showMsg('error', event.message || 'Server error.');
                }
            },
            { buffer:false, escape:true, timeout:120000 }
        );
    }
    </script>
    
    <div class="header-section">
        <apex:image url="{!URLFOR($Resource.Logo)}" styleClass="logo"/>
        <div class="welcome-text">Welcome to IGSTC Portal</div>
    </div>
    
    <div class="main-container" id="signin">
        <apex:image url="{!URLFOR($Resource.VectorSignUp)}" styleClass="login-logo"/>
        <div class="login-title">Sign Up</div>
        
        <!-- message containers used by showMsg -->
        <div id="msg-success" class="alert success"></div>
        <div id="msg-error" class="alert error"></div>
        
        <div class="field-container">
            <!-- Left -->
            <div class="login-section">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fa-solid fa-user"></i>
                        First Name <span class="required">*</span>
                    </label>
                    <input id="reg-firstname" type="text" class="form-input" placeholder="Enter your First Name"/>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-envelope label-icon"></i>
                        Email Address <span class="required">*</span>
                    </label>
                    <input id="reg-email" type="email" class="form-input" placeholder="Enter your Email"/>
                </div>
                <div class="form-group last-group">
                    <label class="form-label">
                        <i class="fas fa-lock label-icon"></i>
                        Re-Enter Password <span class="required">*</span>
                    </label>
                    <input id="reg-confirm" type="password" class="form-input" placeholder="Re-enter Password"/>
                </div>
            </div>
            <!-- Right -->
            <div class="right-section">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fa-solid fa-user"></i>
                        Last Name <span class="required">*</span>
                    </label>
                    <input id="reg-lastname" type="text" class="form-input" placeholder="Enter your Last Name"/>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-lock label-icon"></i>
                        Password <span class="required">*</span>
                    </label>
                    <input id="reg-pass" type="passwordsdfasd" class="form-input" placeholder="Enter your Password"/>
                </div>
                <!-- Captcha -->
                <apex:form id="captchaForm">
    <div class="form-group last-group">
        <label class="form-label">
            <i class="fas fa-shield-alt label-icon"></i>
            Captcha Verification <span class="required">*</span>
        </label>
        <div id="captchaContainer" style="display:flex; align-items:center; gap:10px;">
            <!-- Captcha input -->
            <apex:inputText value="{!userInput}" id="capInput"
                            styleClass="form-input"
                            html-placeholder="Enter Captcha Code"
                            style="flex:1;"/>

            <!-- Captcha code display -->
            <apex:outputText value="{!captchaValue}" id="captchaText"
                             styleClass="captcha-code"
                             style="font-weight:bold; font-size:16px; background:#f0f0f0; padding:5px 10px; border-radius:4px;" />

            <!-- Refresh button -->
            <apex:commandLink action="{!generateCaptcha}" rerender="captchaText" style="text-decoration:none;">
                <apex:image url="{!URLFOR($Resource.VectorRecycle)}" styleClass="captcha-icon" alt="Refresh"/>
            </apex:commandLink>

            <!-- Audio button -->
            <img src="{!URLFOR($Resource.VectorVolume)}"
                 style="cursor:pointer;"
                 class="captcha-icon"
                 alt="Audio"
                 onclick="var a=document.getElementById('captchaAudio'); if(a) a.play();"/>
        </div>

        <!-- For VF error messages -->
        <apex:pageMessages id="msgs"/>
    </div>
                    
                    

             </apex:form>
                
            </div>
            
        </div>
        
        <button id="btn-register"  class="login-btn" onclick="registerNow()">
            Register
            <span id="spinner" class="spinner"></span>
        </button>
        
        <div class="signup-link toggle-btn active" data-target="signin">
            Don't have an account? <a href="#">Sign In</a>
        </div>
    </div>
        
</apex:page>