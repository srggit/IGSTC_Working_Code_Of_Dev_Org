<apex:page sidebar="false" showHeader="false" standardStylesheets="false" controller="RegistrationForm_Controller">
<html>
<head>
    <title>Set New Password - IGSTC</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>

    <c:Libraries ></c:Libraries>
    <apex:stylesheet value="{!$Resource.ApplicantPortalCSS}" />
    <apex:stylesheet value="{!$Resource.ReviewerPortalCss}" />

    <style>
        /* Updated to match second VF page exactly */
        body {
            font-family: "Nunito Sans", sans-serif;
            background-color: #f1f1f1;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        .forgot-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 502px;
            padding: 2.5rem;
            text-align: center;
        }
        .logo-section { 
            margin-bottom: 1.5rem; 
        }
        .logo-section img { 
            width: 100px; 
            height: auto; 
            margin-bottom: 0.5rem; 
        }
        .forgot-title {
            text-align: center;
            font-size: 2.6rem;
            font-weight: 700;
            color: #4F1BA3;
            margin: 1.5rem 0;
        }
        .form-group { 
            text-align: left; 
            margin-bottom: 1.5rem; 
        }
        .form-label { 
            font-weight: 600; 
            color: #4b0082; 
            font-size: 1.6rem; 
            margin-bottom: 0.5rem; 
            display: block; 
        }
        .form-label .required { 
            color: red; 
        }
        .password-input-container { 
            position: relative; 
        }
        .form-input {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #ccc; 
            border-radius: 6px;
            font-size: 1.6rem; 
            box-sizing: border-box; 
            height: 45px;
        }
        .form-input:focus {
            outline: none; 
            border-color: #4b0082; 
            box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.1);
        }
        .password-toggle {
            position: absolute; 
            right: 12px; 
            top: 50%; 
            transform: translateY(-50%);
            background: none; 
            border: none; 
            color: #4b0082; 
            cursor: pointer; 
            font-size: 1.6rem;
        }
        .submit-btn {
            width: 100%; 
            background: #4b0082; 
            color: white; 
            border: none; 
            border-radius: 6px;
            padding: 0.75rem; 
            font-size: 1.7rem; 
            font-weight: 600; 
            cursor: pointer;
            transition: background 0.3s ease; 
            margin-top: 0.5rem; 
            height: 45px;
        }
        .submit-btn:hover { 
            background: #6a0dad; 
        }
        .submit-btn:disabled { 
            background: #cccccc; 
            cursor: not-allowed; 
        }
        .loader {
            display: inline-block; 
            width: 18px; 
            height: 18px;
            border: 2px solid #f3f3f3; 
            border-top: 2px solid #4b0082;
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin-right: 8px;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* Password validation styles */
        #message {
            display: none;
            text-align: left;
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        #message h6 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        #message span {
            display: block;
            margin-bottom: 5px;
            margin-left: 20px;
            font-weight: 400;
        }
        .valid {
            color: green;
        }
        .valid:before {
            position: relative;
            left: -10px;
            content: "✓";
        }
        .invalid {
            color: red;
        }
        .invalid:before {
            position: relative;
            left: -10px;
            content: "✗";
        }
        #mxLen {
            font-weight: 600;
        }
    </style>

    <script>
        var isRegistration = '{!$CurrentPage.parameters.register}';
        var gemail = '{!$CurrentPage.parameters.gemail}';
        var first_name = '{!$CurrentPage.parameters.first_name}';
        var siteUrl = "{!$Label.ApplicantPortalSiteURL}";
        
        function myFunction() {
            var fb = document.getElementById('facebookUrlId');
            fb.href = "https://www.facebook.com/v2.8/dialog/oauth?client_id=" + "{!$Setup.Facebook_API_Details__c.App_Id__c}" + "&response_type=code&redirect_uri=" + "{!$Setup.Facebook_API_Details__c.login_Site_URL__c}" + "&scope=public_profile,email&&auth_type=rerequest";
        }
        function myFunctionforgoogle() {
            var a = document.getElementById('googleUrlId');
            a.href = "https://accounts.google.com/AccountChooser?continue=https://accounts.google.com/o/oauth2/auth?redirect_uri=" + "{!$Setup.Google_API_Details__c.Login_Redirect_URI__c}" + "%26prompt%3Dconsent%26response_type%3Dcode%26client_id=" + "{!$Setup.Google_API_Details__c.Client_Id__c}" + "%26scope%3Dhttps://www.googleapis.com/auth/userinfo.email%2Bhttps://www.googleapis.com/auth/userinfo.email%2Bhttps://www.googleapis.com/auth/userinfo.email%2Bhttps://www.googleapis.com/auth/plus.login%2Bhttps://www.googleapis.com/auth/plus.me%2Bhttps://www.googleapis.com/auth/userinfo.email%2Bhttps://www.googleapis.com/auth/userinfo.profile%2Bhttps://www.googleapis.com/auth/plus.login%2Bhttps://www.googleapis.com/auth/userinfo.email%2Bhttps://www.googleapis.com/auth/userinfo.profile%2Bhttps://www.googleapis.com/auth/plus.login%2Bhttps://www.googleapis.com/auth/plus.login%2Bhttps://www.googleapis.com/auth/plus.login%2Bhttps://www.googleapis.com/auth/plus.me%2Bhttps://www.googleapis.com/auth/userinfo.email%2Bhttps://www.googleapis.com/auth/userinfo.profile%2Bhttps://www.googleapis.com/auth/plus.login%2Bhttps://www.googleapis.com/auth/plus.me%2Bhttps://www.googleapis.com/auth/userinfo.email%2Bhttps://www.googleapis.com/auth/userinfo.profile%2Bhttps://www.googleapis.com/auth/userinfo.email%26access_type%3Doffline%26from_login%3D1%26as%3D-270badd61a3e150b&btmpl=authsub&scc=1&oauth=1";
        }
        
        var app = angular.module('myApp',[]);
        app.controller('myCtrl', function($scope){
            $scope.companyName;
            $scope.showSpinner = true;
            $scope.contactDetails = { FirstName: "", LastName: "", Email: "",MailingPostalCode: "", MailingCountry: "", MailingStreet: "", AccountId: "" };
            $scope.contactDetails.FirstName = first_name;
            $scope.contactDetails.Email = gemail;
            $scope.userSetPassEmail = "";
            $scope.img_If=false;
            $scope.img_workshop=false;
            $scope.img_2plus2=false;
            $scope.img_pecfar=false;
            $scope.img_sing=false;
            $scope.img_wiser=false;
            
            $scope.userName = '';
            $scope.userPassword = '';
            if(isRegistration == "true"){
            }else{
            }
            
            $scope.getCampaign=function(){
                var hashId = '{!$CurrentPage.parameters.id}';
                RegistrationForm_Controller.getCampaign(hashId, function(result, event){
                    if (event.status && result != null) {
                        $scope.res = result;
                        $scope.$apply();
                        if($scope.res == "workshop"){
                            $scope.img_workshop=true;
                        }else if($scope.res == "pecfar"){
                            $scope.img_pecfar=true;
                        }else if($scope.res == "if"){
                            $scope.img_If=true;
                        }
                        else if($scope.res == "sing"){
                            $scope.img_sing=true;
                        }
                        else if($scope.res == "wiser"){
                            $scope.img_wiser=true;
                        }
                        else if($scope.res == "2plus2"){
                            $scope.img_2plus2=true;
                        }
                        $scope.$apply();
                    }
                });
            }
            $scope.getCampaign();
            
            $scope.resetDetails = {userPassword : ""};

            $scope.resetpassApplication = function(){    
                $scope.userPassword;
                var hashId = '{!$CurrentPage.parameters.id}';
                var lowerCaseLetters = /[a-z]/g;
                if($scope.resetDetails.userPassword.match(lowerCaseLetters)) {  
                } else {
                    Swal.fire(
                        'info',
                        'Your password must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters.',
                        'info'
                    );  
                    return;
                }
                var upperCaseLetters = /[A-Z]/g;
                if($scope.resetDetails.userPassword.match(upperCaseLetters)) {
                } else {
                    Swal.fire(
                        'info',
                        'Your password must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters.',
                        'info'
                    );
                    return;
                }
                var numbers = /[0-9]/g;
                if($scope.resetDetails.userPassword.match(numbers)) {  
                } else {
                    Swal.fire(
                        'info',
                        'Your password must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters.',
                        'info'
                    );
                    return;
                }
                var passw = /^(?=.*[0-9])(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{7,30}$/;
                if($scope.resetDetails.userPassword.match(passw)) {  
                } else {
                    Swal.fire(
                        'info',
                        'Your password must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters.',
                        'info'
                    );
                    return;
                }
                if($scope.resetDetails.userPassword.length >= 8) {
                } else {
                    Swal.fire(
                        'info',
                        'Password length should be atleast 8 chars.',
                        'info'
                    );
                    return;
                }
                if($scope.resetDetails.userPassword.length>15) {
                    Swal.fire(
                        'info',
                        'Password maxlength should be 15 characters.',
                        'info'
                    );
                    $("#psw").addClass('border-theme');
                    return;
                }  
                
                RegistrationForm_Controller.ApplicationPasswordReset($scope.resetDetails.userPassword, hashId, function(result, event){
                    if (event.status && result != null) {
                        
                        if (result == 'error_not_found' || result == 'error_exception' || result == 'error') {
                            Swal.fire(
                                'Error',
                                'Password could not be reset. The reset link may be invalid or expired. Please try the "Forgot Password" link again or contact support.',
                                'error'
                            );

                        } else if (result == 'success_no_campaign') {
                            Swal.fire(
                                'Password Changed!',
                                'Your password has been reset successfully. You can now log in.',
                                'success'
                            );

                        } else {
                            $scope.res = result; 
                            $scope.$apply();

                            Swal.fire({
                                icon: 'success',
                                title: 'Password Changed!',
                                html: 'Your password has been reset successfully.<br/><br/>You will be redirected to the login page shortly.',
                                timer: 5000, 
                                timerProgressBar: true,
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                didOpen: () => {
                                    Swal.showLoading()
                                }
                            }).then((redirectResult) => {
                                if($scope.res == "workshop"){
                                    var sitePrefix = window.location.href.includes('/apex') ? '/apex' : '/ApplicantDashboard?campaign=Landing_Page_Workshop';
                                    window.location.replace(window.location.origin + sitePrefix);
                                }else if($scope.res == "pecfar"){
                                    var sitePrefix = window.location.href.includes('/apex') ? '/apex' : '/ApplicantDashboard?campaign=Landing_Page_Pecfar';
                                    window.location.replace(window.location.origin + sitePrefix);
                                }else if($scope.res == "if"){
                                    var sitePrefix = window.location.href.includes('/apex') ? '/apex' : '/ApplicantDashboard?campaign=Landing_Page_Industrial_Fellowship';
                                    window.location.replace(window.location.origin + sitePrefix);
                                }
                                else if($scope.res == "sing"){
                                    var sitePrefix = window.location.href.includes('/apex') ? '/apex' : '/ApplicantDashboard?campaign=LANDING_PAGE_SING';
                                    window.location.replace(window.location.origin + sitePrefix);
                                }
                                else if($scope.res == "wiser"){
                                    var sitePrefix = window.location.href.includes('/apex') ? '/apex' : '/ApplicantDashboard?campaign=LANDING_PAGE_WISER';
                                    window.location.replace(window.location.origin + sitePrefix);
                                }
                                else if($scope.res == "2plus2"){
                                    var sitePrefix = window.location.href.includes('/apex') ? '/apex' : '/ApplicantDashboard?campaign=Landing_Page_Two_Plus_Two';
                                    window.location.replace(window.location.origin + sitePrefix);
                                }
                            });
                        }
                    
                    } else {
                        Swal.fire(
                            'Error',
                            'Password could not be reset. The server returned an unexpected value. Please contact support.',
                            'error'
                        );
                    }
                },
                {escape: true}
                )
            }
            
            $scope.passwordFocus = function() {
                document.getElementById("message").style.display = "block";
            }
            
            $scope.onPassKeyUp = function() {
                var lowerCaseLetters = /[a-z]/g;
                if( $scope.resetDetails.userPassword.match(lowerCaseLetters)) {  
                    document.getElementById("letter").classList.remove("invalid");
                    document.getElementById("letter").classList.add("valid");
                } else {
                    document.getElementById("letter").classList.remove("valid");
                    document.getElementById("letter").classList.add("invalid");
                }
                
                var upperCaseLetters = /[A-Z]/g;
                if( $scope.resetDetails.userPassword.match(upperCaseLetters)) {  
                    document.getElementById("capital").classList.remove("invalid");
                    document.getElementById("capital").classList.add("valid");
                } else {
                    document.getElementById("capital").classList.remove("valid");
                    document.getElementById("capital").classList.add("invalid");
                }
                
                var numbers = /[0-9]/g;
                if( $scope.resetDetails.userPassword.match(numbers)) {  
                    document.getElementById("number").classList.remove("invalid");
                    document.getElementById("number").classList.add("valid");
                } else {
                    document.getElementById("number").classList.remove("valid");
                    document.getElementById("number").classList.add("invalid");
                }
                
                if( $scope.resetDetails.userPassword.length >= 8) {
                    document.getElementById("length").classList.remove("invalid");
                    document.getElementById("length").classList.add("valid");
                } else {
                    document.getElementById("length").classList.remove("valid");
                    document.getElementById("length").classList.add("invalid");
                }
                
                var specialChracter =/[`!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/;
                if( $scope.resetDetails.userPassword.match(specialChracter)) {  
                    document.getElementById("spclChrctr").classList.remove("invalid");
                    document.getElementById("spclChrctr").classList.add("valid");
                } else {
                    document.getElementById("spclChrctr").classList.remove("valid");
                    document.getElementById("spclChrctr").classList.add("invalid");
                }
                
                if($scope.resetDetails.userPassword.length>15){   
                    document.getElementById("mxLen").classList.remove("valid");
                    document.getElementById("mxLen").classList.add("invalid");
                }
                else
                {
                    document.getElementById("mxLen").classList.remove("invalid");
                    document.getElementById("mxLen").classList.add("valid");
                    $("#psw").removeClass('border-theme');
                }
            }
            
            $scope.showHideLoginPassword = function(controlid){
                var x = document.getElementById(controlid);
                var icon = x.parentNode.querySelector('i');
                if (x.type === "password") {
                    x.type = "text";
                    icon.className = "fas fa-eye-slash";
                } else {
                    x.type = "password";
                    icon.className = "fas fa-eye";
                }
            }
        });
    </script>
</head>
<body ng-app="myApp" ng-controller="myCtrl">
    
    <div class="forgot-container">
        <div class="logo-section">
            <apex:image url="{!$Resource.Logo}" alt="IGSTC Logo"/>
        </div>

        <div class="forgot-title">Set New Password</div>
        
        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-lock"></i> New Password <span class="required">*</span>
            </label>
            <div class="password-input-container">
                <input type="password" id="psw" class="form-input" 
                       placeholder="Enter new password"
                       ng-model="resetDetails.userPassword"
                       ng-focus="passwordFocus()"
                       ng-keyup="onPassKeyUp()" />
                <button type="button" class="password-toggle" ng-click="showHideLoginPassword('psw')">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>

        <div id="message">
            <h6><b>Password must contain the following:</b></h6>
            <span id="letter" class="invalid">A <b>lowercase</b> letter</span>
            <span id="capital" class="invalid">A <b>capital (uppercase)</b> letter</span>
            <span id="number" class="invalid">A <b>number</b></span>
            <span id="length" class="invalid">Minimum <b>8 characters</b></span>
            <span id="spclChrctr" class="invalid">A <b>Special character</b></span>
            <span id="mxLen" class="valid">&nbsp;&nbsp;Maximum <b>15 characters</b></span>
        </div>

        <button class="submit-btn" ng-click="resetpassApplication()" type="button">
            Submit
        </button>
    </div>

</body>
</html>
</apex:page>